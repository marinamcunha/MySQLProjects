with fos as (SELECT
mon.FACILITY_ID as FACILITY,
mon.ENTITY_ID as ENTITY_ID,
mon.ENTITY.TYPE as TYPE,
DATETIME(TIMESTAMP_SUB(TIMESTAMP(mon.INHUB_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS INHUB,
DATETIME(TIMESTAMP_SUB(TIMESTAMP(mon.OOT.CTP_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS CPT,
DATETIME(TIMESTAMP_SUB(TIMESTAMP(mon.ENTITY.REFERENCE_DATE_CPT), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS REFERENCE_DATE,
mon.ENTITY.CONTAINER_VERSION as VERSION,
CASE WHEN mon.ENTITY.TYPE = 'shipment' then mon.ENTITY_ID else null end SHIPMENT_ID,
CASE WHEN mon.ENTITY.TYPE = 'hu' THEN mon.ENTITY_ID else tms.TMS_TR_PACKINGLIST_NUMBER end HU,
--CASE WHEN tms.SHP_INB_USER_ID LIKE '%BR.ARA%' THEN 'Araçatuba' WHEN tms.SHP_INB_USER_ID LIKE '%ME.SMG3%' THEN 'Pouso Alegre' ELSE 'Campinas' END ARACATUBA,
CASE WHEN lg.shp_checkpoint_date is null then null else lg.shp_checkpoint_date end PICKED_UP,
tms.TMS_SELLER_INFO_ID as Seller_ID,
seller.CUS_NICKNAME as Nome_Seller,
tms.TMS_TR_PROCES_TYPE as Picking_Type,
tms.TMS_TR_INB_TRUCK_ID as Placa_FM_TMS,
BT.SHP_ROUTE_ID as ROUTE_ID_TMS,
CASE WHEN mon.ENTITY.TYPE = 'shipment' THEN UPPER(tms.SHP_LABEL_ZONE_ID) ELSE UPPER(lk.STEP.OUTBOUND_CHANNEL) END DESTINO

FROM `SHIPPING_BI.BT_SHP_MT_FOS_METRICS` mon
LEFT JOIN `WHOWNER.BT_TMS_TRACKING_STEPS` as tms on tms.SHP_SHIPMENT_ID = CAST(mon.ENTITY_ID as integer) and tms.TMS_TR_LOGISTIC_CENTER_ID = 'XPR1'
LEFT JOIN `SHIPPING_BI.BT_SHP_MT_HU_MONITOREO` as lk on lk.ID = mon.ENTITY_ID and lk.LOGISTIC_CENTER_ID = 'XPR1' and mon.ENTITY.TYPE = 'hu'
LEFT JOIN `WHOWNER.BT_SHP_ELASTICSEARCH_CHECKPOINTS` lg on lg.SHP_SHIPMENT_ID = CAST(mon.ENTITY_ID as integer) and lg.shp_sub_status IN ('picked_up') AND shp_checkpoint_date >= DATE_SUB(DATE_TRUNC(DATE(CURRENT_DATE), MONTH), INTERVAL 1 MONTH)
left join WHOWNER.LK_SEGMENTO_SELLERS AS seller on tms.tms_seller_info_id = seller.CUS_CUST_ID_SEL
left join `WHOWNER.BT_SHP_SHIPMENTS` as BT on CAST(mon.ENTITY_ID as integer) = BT.SHP_SHIPMENT_ID

WHERE
CAST(mon.ENTITY.REFERENCE_DATE_CPT AS DATE) >= DATE_SUB(DATE_TRUNC(DATE(CURRENT_DATE), DAY), INTERVAL 15 DAY)
--CAST(mon.ENTITY.REFERENCE_DATE_CPT AS DATE) = '2023-01-27'
--AND mon.FACILITY_ID = ''
AND mon.ENTITY.DEVOLUTION = FALSE
AND mon.ENTITY.REJECTED = FALSE)

SELECT DISTINCT
mon.FACILITY,
REFERENCE_DATE,
SHIPMENT_ID,
mon.HU,
--CASE WHEN mon.ARACATUBA = 'Araçatuba' then 'v2_Ara' when mon.ARACATUBA = 'Pouso Alegre' then 'v2_Pouso' else VERSION end 
VERSION,
mon.DESTINO as DESTINO,
YMS.GATE_IN_DATE as GATE_IN_FM,
YMS.ROUTE_DATE as DATA_ROTA_FM,
YMS.PLACA_FM as PLACA_FM,
INHUB,
CPT,
CASE WHEN TMS.TMS_TR_LOGISTIC_CENTER_ID = 'XPR1' THEN NULL ELSE TMS.TMS_TR_LOGISTIC_CENTER_ID END PREVIOUS_FACILITY,
DATETIME(TIMESTAMP_SUB(TIMESTAMP(ori.OOT.CTP_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS CPT_PREV_FACILITY,
tms.TMS_TR_DIS_INCLUDE_AT + INTERVAL 1 HOUR AS SHIPPED_PREV_FACILITY,
lk.PLACA_LH_ORIGEM as PLACA_LH_PREV_FACILITY,
lk.SUBCAN as SUBCANALIZATION_PREV_FACILITY,
tms.TMS_TR_PACKINGLIST_NUMBER as HU_ORIGEM,
CASE WHEN
instr(lk.SUBCAN,'_1A') > 0
OR instr(lk.SUBCAN,'_2A') > 0
OR instr(lk.SUBCAN,'_3A') > 0
OR instr(lk.SUBCAN,'_4A') > 0
OR instr(lk.SUBCAN,'_A') > 0
OR instr(lk.SUBCAN,'_B') > 0
OR instr(lk.SUBCAN,'_C') > 0
OR instr(lk.SUBCAN,'_1B') > 0
OR instr(lk.SUBCAN,'_2B') > 0
OR instr(lk.SUBCAN,'_3B') > 0
OR instr(lk.SUBCAN,'_4B') > 0
THEN "Aéreo" ELSE "Rodo" END MODAL,
CASE WHEN VERSION = 'v2' THEN null WHEN instr(tms.SHP_LABEL_ZONE_ID,'_') > 0 then 'v4' else 'v3' end VERSION_ORIGEM,
CASE WHEN VERSION = 'v2' THEN (CASE WHEN CAST(mon.PICKED_UP AS STRING) IS NULL THEN 'Sem Bipe Coleta' ELSE CAST(mon.PICKED_UP AS STRING) END) ELSE 'Outro XD' END PICKED_UP,
mon.Seller_ID,
mon.Nome_Seller,
mon.Picking_Type,
mon.Placa_FM_TMS,
mon.ROUTE_ID_TMS,
YMS.ROUTE_ID_YMS

FROM fos mon
LEFT JOIN `WHOWNER.BT_TMS_TRACKING_STEPS` tms on tms.SHP_SHIPMENT_ID = CAST(mon.SHIPMENT_ID as integer) AND TMS_TR_STEP_ID	 = 1
LEFT JOIN `SHIPPING_BI.BT_SHP_MT_FOS_METRICS` ori on ori.ENTITY_ID = CAST(tms.SHP_SHIPMENT_ID AS STRING) and ori.FACILITY_ID = tms.TMS_TR_LOGISTIC_CENTER_ID
LEFT JOIN 
(SELECT
HU.ID as HU,
STEP.LOGISTIC_CENTER_ID as FACILITY,
HU.EVENT_DATE.SHIPPED AS SHIPPED_ORIGEM,
HU.VEHICLE_PLATE AS PLACA_LH_ORIGEM,
STEP.OUTBOUND_CHANNEL AS SUBCAN,
t

FROM `SHIPPING_BI.BT_SHP_MT_HU_MONITOREO` , unnest(STEP.DESTINATIONS) t where t = 'XPR1') lk on lk.HU = tms.TMS_TR_PACKINGLIST_NUMBER and lk.FACILITY = tms.TMS_TR_LOGISTIC_CENTER_ID

LEFT JOIN (SELECT DISTINCT
TU.SHP_LG_TR_RELATED_ENTITY_ID AS SHP_SHIPMENT_ID,
LG.SHP_LG_VEHICLE_PLATE_ID AS PLACA_FM,
LG.SHP_LG_ROUTE_ID as ROUTE_ID_YMS,
DATETIME(TIMESTAMP(DATETIME_ADD(LG.SHP_LG_DATE_CREATED, INTERVAL 4 HOUR)), 'America/Buenos_Aires') AS ROUTE_DATE,
DATETIME(TIMESTAMP(DATETIME_ADD(yms.GATE_CHECKIN_DATE, INTERVAL 4 HOUR)), 'America/Buenos_Aires') AS GATE_IN_DATE,
ROW_NUMBER ()	OVER (PARTITION BY TU.SHP_LG_TR_RELATED_ENTITY_ID ORDER BY LG.SHP_LG_DATE_CREATED DESC) as Rank

FROM
`WHOWNER.LK_SHP_LG_ROUTES` LG
INNER JOIN `WHOWNER.LK_SHP_LG_ROUTE_STOP` AS RS ON RS.SHP_LG_ROUTE_ID = LG.SHP_LG_ROUTE_ID AND SHP_LG_STOP_TYPE = 'operational'
INNER JOIN WHOWNER.BT_SHP_LG_ORDER AS O ON (O.SHP_LG_ROUTE_STOP_ID = RS.SHP_LG_STOP_ID)
INNER JOIN WHOWNER.LK_SHP_LG_ORDER_TU AS OTU ON (OTU.SHP_LG_ORDER_ID = O.SHP_LG_ORDER_ID)
INNER JOIN `WHOWNER.LK_SHP_LG_TRANSPORT_UNIT` AS TU ON (OTU.SHP_LG_TRANSPORT_UNIT_ID = TU.SHP_LG_TRANSPORT_UNIT_ID AND TU.SHP_LG_TR_STEP_TYPE = 'first_mile')
LEFT JOIN `SHIPPING_BI.BT_SHP_MT_YMS_REQUEST` yms on yms.REQUEST.ROUTE.ID = CAST(LG.SHP_LG_ROUTE_ID AS STRING)

WHERE LG.SHP_LG_TYPE = 'first_mile') AS YMS ON CAST(YMS.SHP_SHIPMENT_ID AS STRING) = mon.SHIPMENT_ID and mon.VERSION = 'v2' and YMS.Rank = 1 and YMS.ROUTE_DATE > DATE_SUB(DATE_TRUNC(DATE(CURRENT_DATE), MONTH), INTERVAL 1 MONTH) 

WHERE INHUB > CPT

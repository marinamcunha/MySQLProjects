with OOT as(

SELECT

 FACILITY_ID as XD,
 
 ENTITY_ID,

 ENTITY.TYPE as TYPE,

 ENTITY.AMOUNT_PACKAGE as AMOUNT_PACKAGE,

 t3.shp_label_zone_name as Canalizacao,

 DATETIME(TIMESTAMP_SUB(TIMESTAMP(INHUB_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS INHUB,

 DATETIME(TIMESTAMP_SUB(TIMESTAMP(OOT.CTP_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS CPT,

 DATETIME(TIMESTAMP_SUB(TIMESTAMP(OOT.SHIPPED_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS SHIPPED,

 DATETIME(TIMESTAMP_SUB(TIMESTAMP(ENTITY.REFERENCE_DATE), INTERVAL -4 HOUR), 'America/Sao_Paulo') AS REFERENCE_DATE,

 OOT.SLA as SLA,

 ENTITY.DEVOLUTION as DEVOLUTION,

 ENTITY.REJECTED as REJECTED,

 ENTITY.CONTAINER_VERSION as CONTAINER_VERSION,

 t3.TMS_TR_DIS_TRUCK_ID as Placa_LH,

 CASE WHEN t2.shp_shipment_id is null and ENTITY.CONTAINER_VERSION <> 'V3' then 'EnoE' else 'Não EnoE' end as EnoE,

 case when t4.Shipment_ID is not null and ENTITY.CONTAINER_VERSION <> 'V3' then 'DEVOS' else 'Não DEVOS' end as Devos,

FROM

 `SHIPPING_BI.BT_SHP_MT_FOS_METRICS` as t1

 LEFT JOIN WHOWNER.BT_SHP_SHIPMENTS as t2 on CAST(t1.ENTITY_ID AS INTEGER)  = t2.shp_shipment_id

 LEFT JOIN `WHOWNER.BT_TMS_TRACKING` as t3 on CAST(t1.ENTITY_ID AS INTEGER) = t3.shp_shipment_id

 left join `WHOWNER.BT_SHP_SHIPMENTS_V2` as shp2 on CAST(t1.ENTITY_ID AS STRING) = shp2.SHP_EXTERNAL_AFFINITY_GROUP_ID

 left join (Select shp.shp_shipment_id as Shipment_ID

  From WHOWNER.BT_SHP_SHIPMENTS shp, unnest (ITEMS) sitems
  
  Left Join WHOWNER.BT_SHP_ELASTICSEARCH_CHECKPOINTS drop_off on (shp.shp_shipment_id = drop_off.shp_shipment_id and drop_off.shp_status = 'ready_to_ship' and   drop_off.shp_sub_status = 'dropped_off')

  Where shp.sit_site_id in ('MLB')
  and   shp.shp_picking_type_id = 'xd_drop_off'
  and   shp.shp_type = 'return'

  qualify row_number() over (partition by shp.shp_shipment_id order by drop_off.shp_checkpoint_date) = 1) as t4 on CAST(t1.ENTITY_ID AS INTEGER) = t4.Shipment_ID

WHERE

 CAST(ENTITY.REFERENCE_DATE AS DATE) BETWEEN '2022-11-13' AND '2022-11-19'

 AND FACILITY_ID in ('XPR1')

ORDER BY

 ENTITY.CONTAINER_VERSION,

 ENTITY.TYPE,

 OOT.SLA),

FM as (
SELECT
C.SHP_CO_SITE_ID AS SIT_SITE_ID,
LG.SHP_LG_ROUTE_ID,
LG.SHP_LG_CODE AS Rota_FM,
CAST(SHIPPING_BI.FN_API_TIMEZONE(C.SHP_CO_SITE_ID, LG.SHP_LG_DATE_CREATED) AS DATE) AS ROUTE_DATE,
RS.SHP_LG_STOP_ID,
TU.SHP_LG_TR_RELATED_ENTITY_ID AS SHP_SHIPMENT_ID
FROM
WHOWNER.LK_SHP_LG_ROUTES LG
INNER JOIN WHOWNER.LK_SHP_LG_ROUTE_STOP AS RS ON RS.SHP_LG_ROUTE_ID = LG.SHP_LG_ROUTE_ID AND SHP_LG_STOP_TYPE = 'operational'
INNER JOIN WHOWNER.BT_SHP_LG_ORDER AS O ON (O.SHP_LG_ROUTE_STOP_ID = RS.SHP_LG_STOP_ID)
INNER JOIN WHOWNER.LK_SHP_COMPANIES AS C ON (C.SHP_COMPANY_ID = LG.SHP_COMPANY_ID)
INNER JOIN WHOWNER.LK_SHP_LG_ORDER_TU AS OTU ON (OTU.SHP_LG_ORDER_ID = O.SHP_LG_ORDER_ID)
INNER JOIN WHOWNER.LK_SHP_LG_TRANSPORT_UNIT AS TU ON
(OTU.SHP_LG_TRANSPORT_UNIT_ID = TU.SHP_LG_TRANSPORT_UNIT_ID
AND TU.SHP_LG_TR_STEP_TYPE = 'first_mile')
WHERE
--CAST(LG.SHP_LG_DATE_CREATED AS DATE) BETWEEN DATE '2022-08-01' AND DATE '2022-08-14'
LG.SHP_LG_TYPE = 'first_mile'
AND C.SHP_CO_SITE_ID = 'MLB'
ORDER BY
LG.SHP_LG_DATE_CREATED ASC,
LG.SHP_LG_ROUTE_ID DESC,
RS.SHP_LG_STOP_ID DESC)

select
t1.XD,

case 
when XD in ('XSP4','BRXSP6','BRXSP10','ARENA') then 'GSP' 
when XD in ('XMG1','XRJ1','BRXES1') then 'RIMES'
when XD in ('BRXGO1','BRXBA1','BRXPE1','BRXJP1','BRXCE1') then 'NENOCO'
when XD in ('XPR1','CAMPINAS','BRXRS1','BRXSC2','BRXSP5','BRXSP7','BRXSP8','BRXPR2','BRXSP11','BRXSP12','BRXPR3') then 'SPISUL'
else null end REGIONAL,
 
t1.ENTITY_ID,

t1.TYPE,

t1.AMOUNT_PACKAGE,

t1.Canalizacao,

t1.INHUB,

t1.CPT,

t1.SHIPPED,

t1.REFERENCE_DATE,

t1.SLA,

t1.DEVOLUTION,

t1.REJECTED,

t1.CONTAINER_VERSION,

t1.Placa_LH,

t1.EnoE,

t1.Devos,

t2.Rota_FM

from OOT as t1
left join FM as t2 on CAST(t1.ENTITY_ID AS INTEGER) = t2.SHP_SHIPMENT_ID
